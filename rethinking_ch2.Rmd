---
title: "Statistical Rethinking"
subtitle: "Chapter 2 notes"
author: "Dan Killian"
date: "1/13/2022"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    toc_depth: 3
    toc_float: true
    theme: paper
    fig.caption: true
    code_folding: hide
    df_print: kable
---

```{r global_options, include=F, warning=F, message=F, echo=F, error=F}
# standard figure size and generate clean output
knitr::opts_chunk$set(fig.height=4, fig.width=6, warning=FALSE, message=FALSE, cache=TRUE, error=T, echo=T)

library(here)
#getwd()
#source(here("../../Dropbox/r prep.R"))
source("prep.R")

```

# Two-way distributions

Let's say we're interested in joint and marginal probabilities of two variables, eye and hair color. Here's a frequency table.

```{r}
freqs <- data.frame(eye_color=c("brown","blue","hazel","green","h"),
                    black = c(.11,.03,.03,.01,.18),
                    brunette = c(.2,.14,.09,.05,.48),
                    red = c(.04,.03,.02,.02,.12),
                    blond = c(.01,.16,.02,.03,.21),
                    e = c(.37,.36,.16,.11,1))

freqs                    

```

We denote the joint probability of eye color *e* and hair color *h* as $p(e,h)$, and note that $p(e, h) = p(h,e)$.

We obtain the marginal probabilities of hair or eye color by summing the joint probabilities across rows (eye color) or columns (hair color). We denote the marginal probability of eye color as $p(e)$ and hair color as $p(h)$, such that $p(e)=\sum_h{p(e,h)}$ and $p(h)=\sum_e{p(e,h)}$.

Generalizing this, consider a row variable *r* and column variable *c*. When the variables are continuous rather than discrete, then we take an integral rather than a sum. So, $p(r)=\int{dc\hspace{1mm} p(r,c)}$ and $p(c)=\int{dr\hspace{1mm}p(r,c)}$.

Suppose we know an individual has blue eyes. Conditional on that information, what are the probabilities for hair color? Blue-eyed individuals make up 36 percent of this sample. We divide the set of joint probabilities of blue eyes and each hair color by the marginal probability of blue eyes, we rescale the probabilities to sum to one, where one represents the sub-sample of people with blue eyes. These probabilities of hair color, conditional on blue eye color, can be denoted as $p(h|e=blue)=p(e=blue,h)/p(e=blue)$

```{r}
h_blue <- freqs[2,2:5] / freqs[2,6]

h_blue

```

And these probabilities should sum to one.

```{r}
sum(h_blue)
```

In general form, we say that $p(h|e)=p(e,h)/p(e)$ which can also be expressed as $p(h|e)=p(e,h)/\sum_hp(e,h*)$, where \_h\*\_ denotes the full set of hair color values to sum over and *e* denotes a specific value of eye color. More generally, we can go back to the row and column variables: $$p(c|r=x)=\frac{p(r=x,c)}{\sum_{c*}{p(r=x,c*)}}$$

Or:

$$p(c|r=x)=\frac{p(r=x,c)}{p(r=x)}$$ Or if you can maintain in your head that the conditioned variable takes on a definite value, we have:

$$p(c|r)=\frac{p(r,c)}{p(r)}$$ Again, just bearing in mind that the variable *r* takes on a specific value.

To get to Bayes Rule, multiply both sides of above by $p(r)$. $$p(c|r)p(r)=p(r,c)$$

We can do the same thing with $p(r|c)$:

$p(r|c)=\frac{p(c,r)}{p(c)}$ and multiply both sides by $p(c)$  

$$
p(r|c)p(c)=p(c,r)
$$

Recall the symmetry with joint probabilities $p(r,c)=p(c,r)$. We can then set the conditional expressions equal to each other.

$$
p(c|r)p(r)=p(r|c)p(c)
$$
Now divide by $p(r)$

$$
p(c|r)=\frac{p(r|c)p(c)}{p(r)}
$$
As a final step, recall that $p(r)$ = 


# 2.1 Garden of forking data

Consider a bag containing four marbles that are either blue or white. We don't know the color of each marble, but we know there could be five possibilities: (1) zero blue, (2) one blue, (3) two blue, (4) three blue, or (5) four blue. Consider each possibility as a conjecture about the actual state of the world. Without evidence, we can only assign equal probabilities to each conjecture, so 20 percent. 

We take a marble from the bag, record its color, return it to the bag, and shake it up. We repeat this until we get three draws. The resulting sequence is blue, white, blue (b,w,b). This is sampling with replacement to produce data that can inform our conjectures. 

Figure 2.2 in the text shows the garden of forking data - the enumeration of all possible paths the marble draws may take to produce the draw that was observed, conditional on each conjecture.

By visually inspecting Figure 2.4, we can count up how many ways the observed draw may arise for each conjecture. For the conjecture of zero blue (1), we can know automatically that the probability is zero. Same for conjecture (5) of four blue. 

For conjecture (2) of one blue, there are three paths through the garden of forking data that produce our observed draw. 

For conjecture (3) of two blue, there are eight paths through the garden of forking data. 

For conjecture (5) of three blue, there are nine paths. 

## From counts to probabilities

We multiply the number of ways the observed data could arise against the probability of each conjecture. We'll call the probability of each conjecture the prior probability. With equal probability, the prior has no effect and we call the resulting operation the plausibility. The plausibilities for the set of conjectures are therefore `r c(0,3,8,9,0)`. So three blue becomes our most likely conjecture, but only slightly more likely than the conjecture of two blue. We can call these plausibilities 'likelihoods'. 

More formally, let's define the following: 

> plausibility $\propto$ ways a conjecture can produce observed data $\times$ prior plausibility of the conjecture

Or more succintly: 

> plausibility #\propto$ likelihood $\times$ prior

Once we get the plausibilities of each conjecture, we normalize them in order to generate a set of probabilities. 

```{r}

ways <- c(0,3,8,9,0)

ways / sum(ways) %>%
  round(3)

```
Because we assigned equal prior probabilities to each conjecture, these probabilities are just a rescaling of what we saw from the plausibility counts: conjecture (3) is most favored, but only by a tiny amount over conjecture (2). One might consider how different two conjectures should be, in order to say one conjecture is more likely than another. With this set of probabilities, we'd probably want to say that conjectures (2) and (3) are about equally likely. 


# 2.2 Building a model

We made it through our first example! Which was designed to tortuously show you that Bayesian analysis is fundamentally just a counting procedure that arise from our assumptions. Given a set of assumptions, we simply compare what is possible. 

Let's proceed to the second example, which will be more like a real-world example. 

```{r}
n_1 <- data.frame(prior=1,
                  param=round(seq(0,1,length.out=20),3)) %>%
  mutate(lik=dbinom(6,9,param))

n_1

```

```{r}
n_1 <- data.frame(toss=rep("w", 50),
                  trials=rep(1,50),
                  success=rep(1,50),
                  p_water = seq(0,1,length.out=50),
                  prior=rep(.02,50)) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

#,         prior2 = prior/sum(prior))
#sum(n_1$lik_raw) # 10 why?

n_1

n_1g <- ggplot(n_1, aes(p_water)) + 
  geom_vline(xintercept=1, size=1.2, color="darkgoldenrod2", alpha=.3) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W",
       caption="n=1\nW\nobserved water 100%") + 
  theme(plot.caption = element_text(vjust=10))

n_1g

d

n_2 <- data.frame(toss=rep("l", 50),
                  trials=rep(2,50),
                  success=rep(1,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_1$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_2

n_2g <- ggplot(n_2, aes(p_water)) + 
  geom_vline(xintercept=.5, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L",
       caption="n=2\nW L\nobserved water 50%") + 
  theme(plot.caption = element_text(vjust=10))

n_2g

library(patchwork)
n_1g + n_2g

d

n_3 <- data.frame(toss=rep("w", 50),
                  trials=rep(3,50),
                  success=rep(2,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_2$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_3

n_3g <- ggplot(n_3, aes(p_water)) + 
  geom_vline(xintercept=.67, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W",
       caption="n=3\nW L W\nobserved water 67%") + 
  theme(plot.caption = element_text(vjust=10))

n_3g


n_1g + n_2g + n_3g


d

n_4 <- data.frame(toss=rep("w", 50),
                  trials=rep(4,50),
                  success=rep(3,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_3$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_4

n_4g <- ggplot(n_4, aes(p_water)) + 
  geom_vline(xintercept=.75, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W W",
       caption="n=4\nW L W W\nobserved water 75%") + 
  theme(plot.caption = element_text(vjust=10))

n_4g


n_1g + n_2g + n_3g + n_4g


d

n_5 <- data.frame(toss=rep("w", 50),
                  trials=rep(5,50),
                  success=rep(4,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_4$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_5

n_5g <- ggplot(n_5, aes(p_water)) + 
  geom_vline(xintercept=.8, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W W W",
       caption="n=5\nW L W W W\nobserved water 80%") + 
  theme(plot.caption = element_text(vjust=10))

n_5g

n_1g + n_2g + n_3g + n_4g + n_5g

d

n_6 <- data.frame(toss=rep("l", 50),
                  trials=rep(6,50),
                  success=rep(4,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_5$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_6

n_6g <- ggplot(n_6, aes(p_water)) + 
  geom_vline(xintercept=.67, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W W W L",
       caption="n=6\nW L W W W L\nobserved water 67%") + 
  theme(plot.caption = element_text(vjust=10))

n_6g

n_1g + n_2g + n_3g + n_4g + n_5g + n_6g

d

n_7 <- data.frame(toss=rep("w", 50),
                  trials=rep(7,50),
                  success=rep(5,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_6$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_7

n_7g <- ggplot(n_7, aes(p_water)) + 
  geom_vline(xintercept=.71, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W W W L W",
       caption="n=7\nW L W W W L W\nobserved water 71%") + 
  theme(plot.caption = element_text(vjust=10))

n_7g

n_1g + n_2g + n_3g + n_4g + n_5g + n_6g + n_7g

d

n_8 <- data.frame(toss=rep("l", 50),
                  trials=rep(8,50),
                  success=rep(5,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_7$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_8

n_8g <- ggplot(n_8, aes(p_water)) + 
  geom_vline(xintercept=.625, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W W W L W L",
       caption="n=8\nW L W W W L W L\nobserved water 63%") + 
  theme(plot.caption = element_text(vjust=10))

n_8g

n_1g + n_2g + n_3g + n_4g + n_5g + n_6g + n_7g + n_8g

d

n_9 <- data.frame(toss=rep("w", 50),
                  trials=rep(9,50),
                  success=rep(6,50),
                  p_water = seq(0,1,length.out=50),
                  prior=n_8$lik) %>%
  mutate(lik_raw = dbinom(success,trials,p_water),
         lik=lik_raw / sum(lik_raw))

n_9

n_9g <- ggplot(n_9, aes(p_water)) + 
  geom_vline(xintercept=.67, size=1.2, color="darkgoldenrod2", alpha=.4) + 
  geom_line(aes(y=prior), size=1.2, color="grey60", linetype="dotdash") +
  geom_line(aes(y=lik), size=1, color="dodgerblue2") + 
  scale_x_continuous(breaks=c(.25,.75),
                     labels=percent) + 
  theme(axis.text.y=element_blank()) +
  labs(x="",
       y="",
       #title="W L W W W L W L W",
       caption="n=9
       W L W W W L W L W
       observed water 67%") + 
  theme(plot.caption = element_text(vjust=10))

n_9g

out <- n_1g + n_2g + n_3g + n_4g + n_5g + n_6g + n_7g + n_8g + n_9g

out

ggsave(out,
       file="viz/Bayesian updating.png",
       device="png",
       type="cairo",
       height=6,
       width=8)

```



```{r remedy001}

set.seed(54)

bin_mod <- data.frame(prior=1,
                      param = round(seq(0,1,length.out=20),3)) %>%
  mutate(lik = dbinom(6, 9, param),
         unstd.posterior = lik*prior,
         posterior = unstd.posterior / sum(unstd.posterior))

bin_mod

```


```{r}

ggplot(bin_mod, aes(param, posterior)) + 
  geom_point(color="dodgerblue", size=2) +
  geom_line(color="dodgerblue", size=1)

```

```{r}

bin_mod2 <- data.frame(prior=1,
                      param = round(seq(0,1,length.out=20),3)) %>%
  mutate(prior = ifelse(param < 0.5 , 0 , 1),
         lik = dbinom(6, 9, param),
         unstd.posterior = lik*prior,
         posterior = unstd.posterior / sum(unstd.posterior),
         prev_posterior = bin_mod$posterior)

bin_mod2

```
```{r}

ggplot(bin_mod2, aes(param, posterior)) + 
  geom_point(color="dodgerblue", size=2) +
  geom_line(color="dodgerblue", size=1) +
  geom_line(aes(y=prev_posterior), color="darkgoldenrod2", size=1, linetype="dotdash")

```

```{r}

bin_mod3 <- data.frame(prior=1,
                      param = round(seq(0,1,length.out=20),3)) %>%
  mutate(prior = exp( -5*abs(param - 0.5)),
         lik = dbinom(6, 9, param),
         unstd.posterior = lik*prior,
         posterior = unstd.posterior / sum(unstd.posterior),
         prev_posterior = bin_mod2$posterior,
         prev_posterior2 = bin_mod$posterior)

bin_mod3

```
```{r}

ggplot(bin_mod3, aes(param, posterior)) + 
  geom_point(color="dodgerblue", size=2) +
  geom_line(color="dodgerblue", size=1) +
  geom_line(aes(y=prev_posterior), color="grey60", size=1, linetype="dotdash") +
  geom_line(aes(y=prev_posterior2), color="darkgoldenrod2", size=1, linetype="dotdash")

```

```{r}

globe.qa <- map(
     alist(
          w ~ dbinom(9,p) ,  # binomial likelihood
          p ~ dunif(0,1)     # uniform prior
     ) ,
     data=list(w=6) )

# display summary of quadratic approximation
precis( globe.qa )

```

```{r}
ggplot()
```


```{r results='asis'}

## R code 2.7
# analytical calculation
w <- 6
n <- 9
curve( dbeta( x , w+1 , n-w+1 ) , from=0 , to=1 )
# quadratic approximation
curve( dnorm( x , 0.67 , 0.16 ) , lty=2 , add=TRUE )
```

```{r}
ggplot(bin_mod, aes(param, lik)) + 
  geom_point() +
  geom_line() +
  labs(x="",
       y="",
       title="")
```
