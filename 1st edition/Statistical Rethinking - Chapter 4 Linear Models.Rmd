
---
title: "Statistical Rethinking"
subtitle: "Chapter 4 - Linear Models"
output:
  html_document:
  toc: yes
toc_depth: '5'
toc_float: yes
---

```{r global_options, include=F}
knitr::opts_chunk$set(fig.width=10, fig.height=8, warning=FALSE, message=FALSE, cache=TRUE, error=T)
```

```{r, include=F}
library(tidyverse)
library(strengejacke)
library(psych)
library(gghighlight)
library(brms)
library(skimr)
library(knitr)
library(xlsx)
library(here)
library(haven)
library(rethinking)
```

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = here())
```

```{r, include=F}
spec <- theme_set(theme_bw() + theme(panel.grid.minor.x=element_blank(),
                             panel.grid.minor.y=element_blank(),
                             plot.title=element_text(face="bold",size=18, hjust=.5, family = "sans"),
                             plot.subtitle = element_text(size=16, family="sans"),
                             plot.caption=element_text(size=12, family="sans"),
                             axis.title=element_text(size=16, family="sans"),
                             axis.text=element_text(size=14, family="sans"),
                             legend.text=element_text(size=14, family="sans"),
                             strip.text=element_text(size=14, family="sans"))) 

options(digits=3, scipen=6)
```

### 4.1 Why normal distributions are normal

Normal distributions arise in nature. Let's look at three processes. 

#### 4.1.1 Normal by addition

McElreath takes the sum of the 16 steps for each of the 1,000 players, which gives rise to the normal distribution. 

```{r}
set.seed(834895)
pos <- data.frame(rep=1:1000,
                  position=replicate(1000, sum(runif(16,-1,1))))
head(pos)
```

```{r}
describe(pos$position)
```


```{r}
ggplot(pos, aes(x=position)) + 
  stat_density(geom="line") +
  spec

```

We can also show the progression along each step as in Figure 4.2. 

```{r}
pos2 <- replicate(100, runif(16,-1,1)) %>% # note we take 16 steps per player now, not the sum of all steps
  as_tibble() 
pos2
```

Each step is a row, each player is a column

We'll add a row for step zero and an index for each player, then pivot the table to long format

```{r}
pos2L <- pos2 %>%
  rbind(0,.) %>%
  mutate(step=0:16) %>%
  pivot_longer(cols=1:100,
               names_to="player",
               values_to="value") %>%
  group_by(player) %>%
  mutate(progress=cumsum(value)) %>%
  ungroup() %>%
  arrange(player)
pos2L
```

Note that when each player was a column, the step value was implicit in each row number. That information was lost when we pivoted the table to long format, so we created the 'step' variable to re-capture the information of which case belonged to which step, for each player. 

Let's also track the mean of all players at each step. 

```{r}
byStep <- pos2L %>%
  group_by(step) %>%
  summarize(progress=mean(progress)) %>%
  mutate(player="stepMean",
         value=NA)
byStep
```

```{r}
#pos2L <- pos2L %>%
#  left_join(byStep)
```
Now we can graph the top panel of Figure 4.2

```{r}
ggplot(pos2L, aes(x=step, y=progress, group=player)) + 
  geom_line(color="skyblue4", alpha=.4, size=.5) +
  geom_line(aes(step, progress), color="darkblue", data=byStep, size=1, alpha=.4) +
  #gghighlight(player=="stepMean") + 
  scale_x_continuous(breaks=0:16) + 
  scale_y_continuous(limits=c(-6,6),
                     breaks=-6:6) + 
  #stat_smooth(aes(progress), color="pink", alpha=.8, se=F) + 
  geom_hline(yintercept=mean(pos2L$progress), color="darkgoldenrod3", size=1, alpha=.4)
```

The grand mean (gold) is only slightly off from zero. The mean at each step size of interest (dark blue) converges toward zero, with higher deviations from zero at earlier steps. Zooming helps to see this. 

```{r}
ggplot(pos2L, aes(x=step, y=progress, group=player)) + 
  geom_line(color="skyblue4", alpha=.4, size=.5) +
  geom_line(aes(step, progress), color="darkblue", data=byStep, size=1, alpha=.4) +
  #gghighlight(player=="stepMean") + 
  scale_x_continuous(breaks=0:16) + 
  scale_y_continuous(limits=c(-1,1),
                     breaks=-1:1) + 
  #stat_smooth(aes(progress), color="pink", alpha=.8, se=F) + 
  geom_hline(yintercept=mean(pos2L$progress), color="darkgoldenrod3", size=1, alpha=.4)
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```


```{r}
```



